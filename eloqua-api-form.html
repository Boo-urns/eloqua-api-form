<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">

<!-- FIREBASE -->
<link rel="import" href="../firebase-element/firebase.html">
<link rel="import" href="../firebase-element/firebase-collection.html">
<link rel="import" href="../firebase-element/firebase-document.html">



<!-- IRON ELEMENTS -->
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-form/iron-form.html">


<!-- PAPER ELEMENTS -->
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">

<!--
Pulls in and parses the eloqua REST API for forms.

REQUIRES A Server to get keys to pull from the API.

Example:

    <eloqua-api-form formid="13" firebaseURL="yourfirebaseurl.com"></eloqua-api-form>

@element eloqua-api-form
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="eloqua-api-form">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }

    </style>

    <iron-ajax
      auto
      url="{{ajaxurl}}"
      handle-as="json"
      on-response="handleResponse"
      debounce-duration="300"
      last-response="{{ajaxResponse}}"></iron-ajax>
    <!-- params='{"alt":"json", "q":"chrome"}' -->





    <firebase-document
     id="firebaseForm"
     location="{{firebaseElqForms}}"
     log="true"
     data="{{firebaseMarkup}}"></firebase-document>

    <firebase-document
      location="https://eloqua-api-test.firebaseio.com/elq"
      data="{{elq}}"></firebase-document>



    <h1>&lt;eloqua-api-form&gt;</h1>
    <content></content>
    {{firebaseElqForms}}
    {{elq}}
    <div id="testForm">{{testForm}}</div>

    <form is="iron-form" id="elqForm" name="[[formName]]" method="post" action="http://localhost:5000/signup">
        <input value="[[formName]]" type="hidden" name="elqFormName"  />
        <input value="[[elq.siteID]]" type="hidden" name="elqSiteId"  />

       <template is="dom-repeat" items="{{elqform}}" as="form" id="formstamp">

          <!-- TEXT INPUTS -->
          <template is="dom-if" if="{{computeInputType(form.displayType, 'text')}}">

            <paper-input label="{{form.name}}" name="{{form.htmlName}}" required auto-validate error-message="{{form.validations.message}}"></paper-input>

          </template>


          <!-- CHECKBOX INPUTS -->
          <template is="dom-if" if="{{computeInputType(form.displayType, 'checkbox')}}">

            <paper-checkbox required name="{{form.htmlName}}" {{computeRequiredCbx(form.htmlName)}}>{{computeCbxLabel(form.name)}}</paper-checkbox>

          </template>


          <!-- SUBMIT -->
          <template is="dom-if" if="{{computeInputType(form.displayType, 'submit')}}">
            <paper-button raised onclick="submitForm(event)">{{form.name}}</paper-button>
          </template>

       </template>
    </form>
  </template>

</dom-module>

<script>
function submitForm(event) {
  Polymer.dom(event).localTarget.parentElement.submit();
}

  Polymer({

    is: 'eloqua-api-form',

    properties: {

      /**
       * `fancy` indicates that the element should don a monocle and tophat,
       * while checking its pocket watch.
       */
      fancy: Boolean,

      /**
        * Firebase eloqua settings to use for the form
      */
      fireElq: {
        type: Object,
        observer: 'fireElqSettings'
      },
      elqform: {
        type: Object,
        notfiy: true
      },
      // elq: {
      //   type: Object,
      //   observer: 'dataChanged'
      // },
      firebaseurl: {
        type: String,
      },
      firebaseElqForms: {
        type: String,
        computed: 'computeFirebaseForms(firebaseurl, formid)'
      },
      firebaseMarkup: {
        type: Object,
        observer: 'firebaseMarkupChanged'
      },
      /**
       * Self explanatory it's eloqua's form id
       *
       */
      formid: Number,
      formName: String, // Set by the API Call

      ajaxurl: String,
      currentTime: {
        type: Number,
        value: function(){ return Date.now() }
      },
      testForm: Object
    },

    // Observers
    observers: [
      'templateSet(templateParsed)'
    ],
    // Listeners

    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
      //this.ajaxurl = 'http://localhost:5000/landingPage/70';
      //console.log('READY', this.formid, 'FIREBASE', this.firebaseMarkup);

      // Listen for when the form is fully stamped out
      this.listen(this.$.formstamp, 'dom-change', 'templateSet');



      //console.log(markup);
      // this.$.auth.signInAnonymously()
      //   .then(function(response) {
      //       console.log("AUTH RESPONSE", response);
      //     }
      //   ).catch(function(error) {
      //       console.log("AUTH ERROR", error);
      //   });

      //console.log(markup, markup['0']);
      // console.log(firebaseTimestamp.length, typeof(firebaseTimestamp));
      // console.log(firebaseTimestamp);
      // //console.log(firebaseTimestamp - currentTime);

      //console.log(this.firebaseMarkup[0].timestamp);
      // this.$.formstamp.addEventListener("dom-change", function(event){
      //   console.log('DOM CHANGE', event);
      //   console.log(event.srcElement.parentElement);
      //   //Polymer.set('templateParsed', true);
      // });
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
      //this.ajaxurl = 'http://localhost:5000/token';

    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior

    /**
     * The `eloqua-api-form-lasers` event is fired whenever `fireLasers` is called.
     *
     * @event eloqua-api-form-lasers
     * @detail {{sound: String}}
     */

    /**
     * Sometimes it's just nice to say hi.
     *
     * @param {string} greeting A positive greeting.
     * @return {string} The full greeting.
     */
    sayHello: function(greeting) {
      var response = greeting || 'Hello World!';
      return 'eloqua-api-form says, ' + response;
    },

    handleResponse: function(response) {
      //console.log('handleResponse', response);
      // if(this.ajaxurl !== 'http://localhost:5000/landingPage/73') {
      //     this.ajaxurl = 'http://localhost:5000/landingPage/73';
      // } else {
      //   this._setupForm(response);
      // }

    },

    _setupForm: function(data) {
      console.log('SETUP FORM', data);
      let html = data.detail.response.htmlContent.html;
      let remove_arr = ['<!DOCTYPE html>', '<html>', '</html>', '<body>', '</body>'];

      // Removing tags specified above
      for(let item of remove_arr) {
        html = html.replace(item, '');
      }
      // Removing styles
      html = html.replace(/([\s\S]*)<style[\s\S]*?<\/style>/g, '$1');

      // Removing <head>
      html = html.replace(/([\s\S]*)<head[\s\S]*?<\/head>/g, '$1');

      // Removing scripts
      html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi
, '');


      // Removing Form (to see what is remaining)
      let htmlNoForm = html.replace(/<form\b[^<]*(?:(?!<\/form>)<[^<]*)*<\/form>/gi
, '');

      // Removing styles that sneak through...
      htmlNoForm = htmlNoForm.replace(/([\s\S]*)<style[\s\S]*?<\/style>/g, '$1');

      htmlNoForm = htmlNoForm.replace(/^\s+|\s+$/g, '');
      htmlNoForm = htmlNoForm.replace(/(\r\n|\n|\r)/gm, '');
      htmlNoForm = htmlNoForm.replace(/ /g,'');

      // Just an empty div which means just the form is on the page
      if(htmlNoForm.length <= 11) {
        let amtForms = data.detail.response.forms.length;

        if(amtForms === 1) {

          console.log(data.detail.response.forms[0]);
          this.formName = data.detail.response.forms[0].htmlName;

          console.log(data.detail.response.forms[0].elements);
          this.elqform = data.detail.response.forms[0].elements;

          let elqFormData = this.elqform;
          elqFormData.timestamp = Date.now();

          this.$.firebaseForm.add(this.elqform);


        } else {
          console.error('NOT EXPECTING MORE THAN 1 FORM FOR NOW');
        }

      } else {
        // Figure out what else is on the page.

      }


    },

    templateSet: function(event) {
      this.unlisten(this.$.formstamp, 'dom-change', 'templateSet');
      console.log(event);
      //console.log(event.srcElement.parentElement.innerHTML);
      //console.log(Polymer.dom(this.$.elqForm).querySelectorAll);
      let markup = Polymer.dom(this.root).querySelectorAll('#elqForm');
      //console.log(typeof(markup), markup);
      console.log(this.$$('#elqForm'));
      //console.log(event.srcElement.items.ownerDocument);
      //this.testForm = event.srcElement.items.ownerDocument.;
      // markup = markup.replace(/([\s\S]*)<template[\s\S]*?<\/template>/g, '$1');
      // console.log(markup);
      // this.formMarkup.timestamp =  Date.now();

    //  console.log(this.formMarkup);
      //this.$.firebaseForm.add(this.formMarkup);
      //this.$.firebase.add(this.$['add-category'].serialize().category)
    },

    dataChanged: function(newData, oldData) {
      console.log('FIREBASE DATA CHANGE', newData);
    },

    firebaseMarkupChanged: function(newData, oldData) {
      let timestamp;
      let currentTimestamp = Date.now();
      let formData;
      let outputForm = [];

      for(var prop in newData) {
        timestamp = newData[prop].timestamp
        formData = newData[prop];
      }

      console.log(currentTimestamp, timestamp, (currentTimestamp - timestamp));

      if((currentTimestamp - timestamp)  > 60 * 60 * 24 * 1000) {
        console.log("NEED TO PULL NEW DATA FROM ELQ");
      } else {
        console.log("UNDER 1 DAY USE DB");
        for(var prop in formData) {
          console.log(prop, formData[prop]);
          outputForm.push(formData[prop]);
        }

        this.elqform = outputForm;

        //console.log(this.elqform);
      }

    },

    // Actually it's an eloqua landing page that has the form on it
    computeFirebaseForms: function(firebase, formid) {
      return firebase + '/forms/' + formid;
    },
    /**
     * Pass in the inputType and typeExpecting to return boolean
     *
     * @param {string} the input type
     * @param {string} input type expecting
     * @return {boolean} If the input type is text
     */
    computeInputType: function(inputType, typeExpecting) {
      return inputType === typeExpecting
                ? true : false;
    },

    /**
     * Pass the checkbox name to return if required
     *
     * @param {string} the checkbox name
     * @return {string} 'required' or ''
     */
    computeRequiredCbx: function(cbxName) {
      return cbxName === 'confirm' ?
              'required' : '';
    },

    /**
     * Figure out the checkbox label
     *
     * To insert the massive copy for the checbox. Feel free to remove method
     * @param {string} the checkbox name
     * @return {string} same label or corporate text
     */
    computeCbxLabel: function(cbxName) {
      return cbxName.toLowerCase() != 'opt in'
              ? cbxName
              : 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus nisi ligula, auctor eu sem et, pharetra fermentum elit. Proin a libero condimentum, cursus odio at, cursus tortor. Praesent placerat molestie risus, et condimentum eros ultricies et. Donec tempor semper justo. Duis vitae tincidunt magna, non ornare lacus. Praesent fringilla mi eget felis aliquam consectetur. ';

    },

    fireElqSettings: function(newData, oldData) {
      console.log('ELQ SETTINGS', newData);
    },

    /**
     * Attempt to destroy this element's enemies with a beam of light!
     *
     * Or, at least, dispatch an event in the vain hope that someone else will
     * do the zapping.
     */
    fireLasers: function() {
      this.fire('eloqua-api-form-lasers', {sound: 'Pew pew!'});
    }

  });

</script>
<!--<script type='text/javascript'>
var timerId = null, timeout = 5;
</script>
<script type='text/javascript'>
function WaitUntilCustomerGUIDIsRetrieved() {
if (!!(timerId)) {
    if (timeout == 0) {
return;
}
if (typeof this.GetElqCustomerGUID === 'function') {
        document.forms["TEST_signup-1465575899166"].elements["elqCustomerGUID"].value = GetElqCustomerGUID();
return;
}
timeout -= 1;
}
timerId = setTimeout("WaitUntilCustomerGUIDIsRetrieved()", 500);
return;
}
window.onload = WaitUntilCustomerGUIDIsRetrieved;
_elqQ.push(['elqGetCustomerGUID']);
</script>-->
