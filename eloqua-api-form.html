<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">

<!-- FIREBASE -->
<link rel="import" href="../firebase-element/firebase.html">
<link rel="import" href="../firebase-element/firebase-collection.html">
<link rel="import" href="../firebase-element/firebase-document.html">



<!-- IRON ELEMENTS -->
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-form/iron-form.html">


<!-- PAPER ELEMENTS -->
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">

<!--
Pulls in and parses the eloqua REST API for landing page. We are pulling data from the landing page for the form per governance requirements.

REQUIRES A Server to get keys to pull from the API.

Example:

    <eloqua-api-form landingpageid="73" firebaseURL="yourfirebaseurl.com" settingspath="/elq/settings"></eloqua-api-form>

@element eloqua-api-form
@demo demo/index.html
-->
<dom-module id="eloqua-api-form">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }

    </style>


    <iron-ajax
      auto
      url="{{ajaxurl}}"
      handle-as="json"
      on-response="handleResponse"
      debounce-duration="300"
      last-response="{{ajaxResponse}}"></iron-ajax>

    <firebase-document
     id="firebaseForm"
     location="{{firebaseElqForms}}"
     data="{{firebaseMarkup}}"></firebase-document>

    <firebase-document
      location="{{firebaseSettingsPath}}"
      data="{{firebaseElq}}"></firebase-document>


    <h1>&lt;eloqua-api-form&gt;</h1>
    <content></content>

    <form is="iron-form" id="elqForm" name="[[formName]]" method="post" action="http://localhost:5000/signup">
        <input value="[[formName]]" type="hidden" name="elqFormName"  />
        <input value="[[firebaseElq.siteID]]" type="hidden" name="elqSiteId"  />

       <template is="dom-repeat" items="{{elqform}}" as="form" id="formstamp">

          <!-- TEXT INPUTS -->
          <template is="dom-if" if="{{computeInputType(form.displayType, 'text')}}">

            <paper-input label="{{form.name}}" name="{{form.htmlName}}" required auto-validate error-message="{{form.validations.message}}"></paper-input>

          </template>


          <!-- CHECKBOX INPUTS -->
          <template is="dom-if" if="{{computeInputType(form.displayType, 'checkbox')}}">

            <paper-checkbox required name="{{form.htmlName}}" {{computeRequiredCbx(form.htmlName)}}>{{computeCbxLabel(form.name)}}</paper-checkbox>

          </template>


          <!-- SUBMIT -->
          <template is="dom-if" if="{{computeInputType(form.displayType, 'submit')}}">
            <paper-button raised onclick="submitForm(event)">{{form.name}}</paper-button>
          </template>

       </template>
    </form>
  </template>

</dom-module>

<script>
function submitForm(event) {
  Polymer.dom(event).localTarget.parentElement.submit();
}

  Polymer({

    is: 'eloqua-api-form',

    properties: {
      /**
       * `elqform` Pulled from the API or Firebase database
       * to stamp out the template for the form
       */
      elqform: {
        type: Object,
        notfiy: true
      },

      /**
       * `firebaseurl` URL for the root of your firebase database
       * 'https://your-app.firebaseio.com'
       */
      firebaseurl: {
        type: String,
      },

      /**
       * `firebaseElq` Pulling in specific data from firebase
       *
       */
      firebaseElq: {
        type: Object,
        observer: 'fireElqSettings'
      },

      /**
       * `firebaseElqForms` Computed property for path to the specified form
       *
       */
      firebaseElqForms: {
        type: String,
        computed: 'computeFirebaseForms(firebaseurl, landingpageid)'
      },

      /**
       * `firebaseElqForms` Computed property for path to eloqua settings
       *
       */
      firebaseSettingsPath: {
        type: String,
        computed: 'computeFirebaseSettingPath(firebaseurl, settingspath)'
      },

      /**
       * `firebaseMarkup` data from firebase for specified form on the landing page
       *
       */
      firebaseMarkup: {
        type: Object,
        observer: 'firebaseMarkupChanged'
      },

      /**
       * Self explanatory it's eloqua's landing page that the form is on
       *
       */
      landingpageid: Number,

      /**
       * Settings Path for data related to eloqua settings (actionURL, siteID etc...)
       *
       */
      settingspath: String,
      /**
       * `formName` set by the API and or Firebase call.
       * Used for the required input and form name for eloqua.
       */
      formName: String,
      ajaxurl: String
    },


    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
      //this.ajaxurl = 'http://localhost:5000/landingPage/70';
      //console.log('READY', this.formid, 'FIREBASE', this.firebaseMarkup);
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).


    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior


    handleResponse: function(response) {
      console.log('handleResponse', response);
      if(this.ajaxurl !== 'http://localhost:5000/landingPage/' + this.landingpageid) {
          this.ajaxurl = 'http://localhost:5000/landingPage/' + this.landingpageid;
      } else {
        this._setupForm(response);
      }

    },

    _setupForm: function(data) {
      console.log('SETUP FORM', data);
      let html = data.detail.response.htmlContent.html;
      let remove_arr = ['<!DOCTYPE html>', '<html>', '</html>', '<body>', '</body>'];

      // Removing tags specified above
      for(let item of remove_arr) {
        html = html.replace(item, '');
      }
      // Removing styles
      html = html.replace(/([\s\S]*)<style[\s\S]*?<\/style>/g, '$1');

      // Removing <head>
      html = html.replace(/([\s\S]*)<head[\s\S]*?<\/head>/g, '$1');

      // Removing scripts
      html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi
, '');


      // Removing Form (to see what is remaining)
      let htmlNoForm = html.replace(/<form\b[^<]*(?:(?!<\/form>)<[^<]*)*<\/form>/gi
, '');

      // Removing styles that sneak through...
      htmlNoForm = htmlNoForm.replace(/([\s\S]*)<style[\s\S]*?<\/style>/g, '$1');

      htmlNoForm = htmlNoForm.replace(/^\s+|\s+$/g, '');
      htmlNoForm = htmlNoForm.replace(/(\r\n|\n|\r)/gm, '');
      htmlNoForm = htmlNoForm.replace(/ /g,'');

      // Just an empty div which means just the form is on the page
      if(htmlNoForm.length <= 11) {

        if(data.detail.response.forms.length === 1) {

          this.formName = data.detail.response.forms[0].htmlName;
          this.elqform = data.detail.response.forms[0].elements;

          let elqFormData = {};

          for(var prop in this.elqform) {
            elqFormData[prop] = this.elqform[prop];
          }


          elqFormData.formName  = this.formName;
          elqFormData.timestamp = Date.now();

          this.$.firebaseForm.set( elqFormData );


          this.firebaseMarkup = elqFormData;

        } else {
          console.error('NOT EXPECTING MORE THAN 1 FORM FOR NOW');
        }

      } else {
        // Figure out what else is on the page.
        console.error("MoAr then just the form");
      }


    },




    // -----------------------------------------------------------------
    //
    // OBSERVERS
    //
    // -----------------------------------------------------------------

    firebaseMarkupChanged: function(newData, oldData) {
      let timestamp;
      let currentTimestamp = Date.now();
      let formData = {};
      let outputForm = [];

      console.log(newData);
      for(var prop in newData) {
        formData[prop]= newData[prop];
      }

      timestamp = formData.timestamp;

      console.log(currentTimestamp, timestamp, (currentTimestamp - timestamp));
      //if(1 ==1) {
      if((currentTimestamp - timestamp)  > (60 * 60 * 24 * 1000) || timestamp === undefined) {
        console.log("NEED TO PULL NEW DATA FROM ELQ");
        this.ajaxurl = 'http://localhost:5000/token';
      } else {
        console.log("UNDER 1 DAY USE DB");

        for(var prop in formData) {
          outputForm.push(formData[prop]);

          if(prop === 'formName') {
            this.formName = formData[prop];
          }
        }

        this.elqform = outputForm;

      }

    },


    fireElqSettings: function(newData, oldData) {
      console.log('ELQ SETTINGS', newData);
    },



    // -----------------------------------------------------------------
    //
    // COMPUTED PROPERTIES
    //
    // -----------------------------------------------------------------

    // Actually it's an eloqua landing page that has the form on it
    // But we're just pulling the form
    computeFirebaseForms: function(firebase, landingPageID) {
      return firebase + '/forms/' + landingPageID;
    },

    /**
     * Pass in firebase url and settings path
     * to compute the value for firebaseSettings
     * Used for location
     *
     * @param {string} firebase url
     * @param {string} settings path
     * @return {string} firebase url + settings path
    */
    computeFirebaseSettingPath(firebase, settings) {
      console.log("COMPUTE FB SETTINGS", firebase + settings);
      return firebase + settings;
    },


    /**
     * Pass in the inputType and typeExpecting to return boolean
     *
     * @param {string} the input type
     * @param {string} input type expecting
     * @return {boolean} If the input type is text
     */
    computeInputType: function(inputType, typeExpecting) {
      return inputType === typeExpecting
                ? true : false;
    },


    /**
     * Pass the checkbox name to return if required
     *
     * @param {string} the checkbox name
     * @return {string} 'required' or ''
     */
    computeRequiredCbx: function(cbxName) {
      return cbxName === 'confirm' ?
              'required' : '';
    },


    /**
     * Figure out the checkbox label
     *
     * To insert the massive copy for the checbox. Feel free to remove method
     * @param {string} the checkbox name
     * @return {string} same label or corporate text
     */
    computeCbxLabel: function(cbxLabel) {
      return cbxLabel.toLowerCase() != 'opt in'
              ? cbxLabel
              : 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus nisi ligula, auctor eu sem et, pharetra fermentum elit. Proin a libero condimentum, cursus odio at, cursus tortor. Praesent placerat molestie risus, et condimentum eros ultricies et. Donec tempor semper justo. Duis vitae tincidunt magna, non ornare lacus. Praesent fringilla mi eget felis aliquam consectetur. ';

    },

  });

</script>
<!--<script type='text/javascript'>
var timerId = null, timeout = 5;
</script>
<script type='text/javascript'>
function WaitUntilCustomerGUIDIsRetrieved() {
if (!!(timerId)) {
    if (timeout == 0) {
return;
}
if (typeof this.GetElqCustomerGUID === 'function') {
        document.forms["TEST_signup-1465575899166"].elements["elqCustomerGUID"].value = GetElqCustomerGUID();
return;
}
timeout -= 1;
}
timerId = setTimeout("WaitUntilCustomerGUIDIsRetrieved()", 500);
return;
}
window.onload = WaitUntilCustomerGUIDIsRetrieved;
_elqQ.push(['elqGetCustomerGUID']);
</script>-->
