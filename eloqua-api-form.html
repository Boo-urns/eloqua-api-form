<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">

<!-- FIREBASE -->
<link rel="import" href="../firebase-element/firebase.html">
<link rel="import" href="../firebase-element/firebase-collection.html">
<link rel="import" href="../firebase-element/firebase-document.html">



<!-- IRON ELEMENTS -->
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">


<!-- PAPER ELEMENTS -->
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">

<!--
Pulls in and parses the eloqua REST API for landing page. We are pulling data from the landing page for the form per governance requirements.

REQUIRES A Server to get keys to pull from the API.

Example:

    <eloqua-api-form landingpageid="73" firebaseURL="yourfirebaseurl.com" settingspath="/elq/settings"></eloqua-api-form>

@element eloqua-api-form
@demo demo/index.html
-->
<dom-module id="eloqua-api-form">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        --paper-checkbox-label-spacing: 20px;
        --paper-checkbox-checked-color: #494949;
        --paper-input-container-label-focus: {
          color: #494949;
        };
        --paper-input-container-underline-focus: {
          background: #ffca00;
        };
      }
      paper-input,
      paper-checkbox {
        padding: 10px 2.5%;
      }
      paper-input,
      paper-dropdown-menu {
        text-transform: uppercase;
      }
      paper-input.small {
        @apply(--layout-flex);
        width: 33%;
        display: inline-block;
        box-sizing: border-box;
      }
      paper-input.medium {
        @apply(--layout-flex);
        width: 48.75%; /* 48.75 * 2 = 97.5 to get the amt padding on the right*/
        padding: 10px 0 10px 2.5%;
        display: inline-block;
        box-sizing: border-box;
      }

      paper-dropdown-menu.large {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 2.5%;
      }
      paper-button.submit {
        background: #ffca00;
        border-radius: 0;
        width: 95%;
        margin: 10px 2.5%;
        box-sizing: border-box;

      }
    </style>


    <iron-ajax
      auto
      url="{{ajaxurl}}"
      handle-as="json"
      on-response="handleResponse"
      debounce-duration="300"></iron-ajax>
    <!-- <iron-ajax
      auto
      url="[[formAction]]"
      params={}
      handle-as="json"
      on-response="formResponse"></iron-ajax>
       -->
    <firebase-document
     id="firebaseForm"
     location="{{firebaseElqForms}}"
     data="{{firebaseMarkup}}"></firebase-document>

    <firebase-document
      id="firebaseOptionList"
      location="{{firebaseSettingsPath}}"
      data="{{firebaseElq}}"></firebase-document>

    <firebase-document
      location="{{firebaseOptionListPath}}"
      data="{{firebaseOptionList}}"></firebase-document>


    <h1>&lt;eloqua-api-form&gt;</h1>
    <content></content>

    <form is="iron-form" id="elqForm" class="horizontal layout wrap" name="[[formName]]" method="post" action="http://localhost:5000/signup">
        <input value="[[formName]]" type="hidden" name="elqFormName"  />
        <input value="[[firebaseElq.siteID]]" type="hidden" name="elqSiteId"  />

       <template is="dom-repeat" items="{{elqform}}" as="input" id="formstamp">

          <!-- TEXT INPUTS -->
          <template is="dom-if" if="{{computeInputType(input.displayType, 'text')}}">

              <paper-input label="{{input.name}}" name="{{input.htmlName}}" class$="[[returnFieldSize(input.style)]]" required auto-validate error-message="{{input.validations.message}}"></paper-input>

          </template>

          <!-- DROPDOWN INPUTS -->
          <template is="dom-if" if="{{computeInputType(input.displayType, 'singleSelect')}}">

            <paper-dropdown-menu label="{{input.name}}" selected-item="{{selectedItem}}" class$="[[returnFieldSize(input.style)]]" horizontal-align="left">
              <paper-listbox class="dropdown-content">

              <template is="dom-repeat" items="{{firebaseOptionList.options}}" as="list" filter="{{computeFilter(list)}}">
                <paper-item value="{{list.value}}">{{list.displayName}}</paper-item>
              </template>

              </paper-listbox>
            </paper-dropdown-menu>
            <input name="{{input.name}}" type="hidden" value="[[selectedItem.value]]">
          </template>


          <!-- CHECKBOX INPUTS -->
          <template is="dom-if" if="{{computeInputType(input.displayType, 'checkbox')}}">

            <paper-checkbox required name="{{input.htmlName}}" {{computeRequiredCbx(input.htmlName)}}>{{computeCbxLabel(input.name)}}</paper-checkbox>

          </template>


          <!-- SUBMIT -->
          <template is="dom-if" if="{{computeInputType(input.displayType, 'submit')}}">
            <paper-button class="submit" onclick="submitForm(event)">{{input.name}}</paper-button>
          </template>

       </template>
    </form>
  </template>

</dom-module>
<!-- POLYFILL FOR Object.assign -->
<script>
if (typeof Object.assign != 'function') {
Object.assign = function(target) {
  'use strict';
  if (target == null) {
    throw new TypeError('Cannot convert undefined or null to object');
  }

  target = Object(target);
  for (var index = 1; index < arguments.length; index++) {
    var source = arguments[index];
    if (source != null) {
      for (var key in source) {
        if (Object.prototype.hasOwnProperty.call(source, key)) {
          target[key] = source[key];
        }
      }
    }
  }
  return target;
};
}

if (!Object.is) {
  Object.is = function(x, y) {
    // SameValue algorithm
    if (x === y) { // Steps 1-5, 7-10
      // Steps 6.b-6.e: +0 != -0
      return x !== 0 || 1 / x === 1 / y;
    } else {
      // Step 6.a: NaN == NaN
      return x !== x && y !== y;
    }
  };
}
</script>

<script>

function submitForm(event) {
  Polymer.dom(event).localTarget.parentElement.submit();
}

  Polymer({

    is: 'eloqua-api-form',

    properties: {
      /**
       * `elqform` Pulled from the API or Firebase database
       * to stamp out the template for the form
       */
      elqform: {
        type: Object,
        notfiy: true
      },

      /**
       * `firebaseurl` URL for the root of your firebase database
       * 'https://your-app.firebaseio.com'
       */
      firebaseurl: {
        type: String,
      },

      /**
       * `firebaseElq` Pulling in specific data from firebase
       *
       */
      firebaseElq: {
        type: Object,
        observer: 'fireElqSettings'
      },

      /**
       * `firebaseElqForms` Computed property for path to the specified form
       *
       */
      firebaseElqForms: {
        type: String,
        computed: 'computeFirebaseForms(firebaseurl, landingpageid)'
      },

      /**
       * `firebaseElqForms` Computed property for path to eloqua settings
       *
       */
      firebaseSettingsPath: {
        type: String,
        computed: 'computeFirebaseSettingPath(firebaseurl, settingspath)'
      },

      /**
       * `firebaseMarkup` data from firebase for specified form on the landing page
       *
       */
      firebaseMarkup: {
        type: Object,
        observer: 'firebaseMarkupChanged'
      },

      firebaseOptionListPath: {
        type: String,
      },
      firebaseOptionList: {
        type: Object,
        observer: 'firebaseOptionChanged'
      },
      optionLists: {
        type: Array
      },
      /**
       * Self explanatory it's eloqua's landing page that the form is on
       *
       */
      landingpageid: Number,

      /**
       * Settings Path for data related to eloqua settings (actionURL, siteID etc...)
       *
       */
      settingspath: String,
      /**
       * `formName` set by the API and or Firebase call.
       * Used for the required input and form name for eloqua.
       */
      formName: String,
      ajaxurl: String,

      ajaxResponse: {
        type: String,
        value: 'handleResponse'
      }
    },


    // Element Lifecycle

    ready: function() {
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
      //this.ajaxurl = 'http://localhost:5000/landingPage/70';
      //console.log('READY', this.formid, 'FIREBASE', this.firebaseMarkup);
    },

    attached: function() {
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).


    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Element Behavior


    handleResponse: function(response) {
      console.log('handleResponse', response);

      if(this.ajaxurl.indexOf('optionList') !== -1) {
        let idx = this.ajaxurl.indexOf('optionList');
        this._setupSelect(response,  this.ajaxurl.substring(idx + 11));
      }
      else if (this.ajaxurl !== 'http://localhost:5000/landingPage/' + this.landingpageid) {
          this.ajaxurl = 'http://localhost:5000/landingPage/' + this.landingpageid;
      } else {
        this._setupForm(response);
      }

    },

    _setupForm: function(data) {
      console.log('SETUP FORM', data);
      let html = data.detail.response.htmlContent.html;
      let remove_arr = ['<!DOCTYPE html>', '<html>', '</html>', '<body>', '</body>'];

      // Removing tags specified above
      for(let item of remove_arr) {
        html = html.replace(item, '');
      }
      // Removing styles
      html = html.replace(/([\s\S]*)<style[\s\S]*?<\/style>/g, '$1');

      // Removing <head>
      html = html.replace(/([\s\S]*)<head[\s\S]*?<\/head>/g, '$1');

      // Removing scripts
      html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi
, '');


      // Removing Form (to see what is remaining)
      let htmlNoForm = html.replace(/<form\b[^<]*(?:(?!<\/form>)<[^<]*)*<\/form>/gi
, '');

      // Removing styles that sneak through...
      htmlNoForm = htmlNoForm.replace(/([\s\S]*)<style[\s\S]*?<\/style>/g, '$1');

      htmlNoForm = htmlNoForm.replace(/^\s+|\s+$/g, '');
      htmlNoForm = htmlNoForm.replace(/(\r\n|\n|\r)/gm, '');
      htmlNoForm = htmlNoForm.replace(/ /g,'');

      // Just an empty div which means just the form is on the page
      if(htmlNoForm.length <= 11) {

        if(data.detail.response.forms.length === 1) {

          this.formName = data.detail.response.forms[0].htmlName;
          this.elqform = data.detail.response.forms[0].elements;

          let elqFormData = {};

          for(var prop in this.elqform) {
            elqFormData[prop] = this.elqform[prop];
          }


          elqFormData.formName  = this.formName;
          elqFormData.timestamp = Date.now();

          //this.$.firebaseForm.set( elqFormData );

          this.firebaseMarkup = elqFormData;

        } else {
          console.error('NOT EXPECTING MORE THAN 1 FORM FOR NOW');
        }

      } else {
        // Figure out what else is on the page.
        console.error("MoAr then just the form");
      }


    },




    _setupSelect: function(data, id) {
      console.log("setup SELECT", data);

      // Removing options with no value!
      let filteredOptions = data.detail.response.elements.filter(opt =>
                                opt.value !== undefined
                                ? opt : '');

      this.firebaseOptionListPath = this.firebaseurl + '/elq/optionList/' + id;
      this.firebaseOptionList = { options: filteredOptions };
    },




    returnFieldSize: function(styles) {
      styles = JSON.parse(styles);
      return styles.fieldSize;
    },




    // -----------------------------------------------------------------
    //
    // OBSERVERS
    //
    // -----------------------------------------------------------------

    firebaseMarkupChanged: function(newData, oldData) {
      let timestamp;
      let currentTimestamp = Date.now();
      let formData = {};
      let outputForm = [];

      for(var prop in newData) {
        formData[prop]= newData[prop];
      }

      timestamp = formData.timestamp;

      // if(oldData) {
      //   if(newData.hasOwnProperty('timestamp') && oldData.hasOwnProperty('timestamp')) {
      //     let tempNewData = Object.assign({}, newData);
      //     delete tempNewData.timestamp;
      //
      //     let tempOldData = Object.assign({}, oldData);
      //     delete tempOldData.timestamp;
      //     console.log(this._objIsEqual(tempNewData, tempOldData), tempNewData, tempOldData);
      //   }
      // }

      if((currentTimestamp - timestamp)  > (60 * 60 * 24 * 1000) || timestamp === undefined) {
        console.log("NEED TO PULL NEW DATA FROM ELQ");
        this.ajaxurl = 'http://localhost:5000/token';
      } else {
        console.log("UNDER 1 DAY USE DB");
        let optionListIds = []; // store optionListIds here

        for( var prop in formData ) {
          outputForm.push(formData[prop]);

          if( prop === 'formName' ) {
            this.formName = formData[prop];
          }

          if( formData[prop]['displayType'] === 'singleSelect' ) {
            optionListIds.push(parseInt(formData[prop]['optionListId']));
          }

        }


        this.elqform = outputForm;

        // If optionListIds > 0 we have some select inputs!
        if ( optionListIds.length > 0 ) {

          this.ajaxResponse = 'handleOptionLists';

          for( let i = 0; i < optionListIds.length; i++ ) {
              this.firebaseOptionListPath = `${this.firebaseurl}/elq/optionList/${optionListIds[i]}`;
          }

          this.optionLists = optionListIds;
        }

      }

    },


    fireElqSettings: function(newData, oldData) {
      console.log('ELQ SETTINGS', newData);
    },



    firebaseOptionListChange: function(newData, oldData) {
      console.log("FIREBASE OPT LIST", newData);

    },


    firebaseOptionChanged: function(newOpt, oldOpt) {
      if(newOpt !== null) {
        this.optionLists.shift();
      } else {
        this.ajaxurl = `http://localhost:5000/optionList/${this.optionLists[0]}`;
      }

      console.log('FIREBASE OPTIONS', newOpt);
    },




    // -----------------------------------------------------------------
    //
    // COMPUTED PROPERTIES
    //
    // -----------------------------------------------------------------

    // Actually it's an eloqua landing page that has the form on it
    // But we're just pulling the form
    computeFirebaseForms: function(firebase, landingPageID) {
      return firebase + '/elq/forms/' + landingPageID;
    },

    /**
     * Pass in firebase url and settings path
     * to compute the value for firebaseSettings
     * Used for location
     *
     * @param {string} firebase url
     * @param {string} settings path
     * @return {string} firebase url + settings path
    */
    computeFirebaseSettingPath(firebase, settings) {
      console.log("COMPUTE FB SETTINGS", firebase + settings);
      return firebase + settings;
    },


    /**
     * Pass in the inputType and typeExpecting to return boolean
     *
     * @param {string} the input type
     * @param {string} input type expecting
     * @return {boolean} If the input type is text
     */
    computeInputType: function(inputType, typeExpecting) {
      return inputType === typeExpecting
                ? true : false;
    },


    /**
     * Pass the checkbox name to return if required
     *
     * @param {string} the checkbox name
     * @return {string} 'required' or ''
     */
    computeRequiredCbx: function(cbxName) {
      return cbxName === 'confirm' ?
              'required' : '';
    },


    /**
     * Figure out the checkbox label
     *
     * To insert the massive copy for the checbox. Feel free to remove method
     * @param {string} the checkbox name
     * @return {string} same label or corporate text
     */
    computeCbxLabel: function(cbxLabel) {
      return cbxLabel.toLowerCase() != 'opt in'
              ? cbxLabel
              : 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus nisi ligula, auctor eu sem et, pharetra fermentum elit. Proin a libero condimentum, cursus odio at, cursus tortor. Praesent placerat molestie risus, et condimentum eros ultricies et. Donec tempor semper justo. Duis vitae tincidunt magna, non ornare lacus. Praesent fringilla mi eget felis aliquam consectetur. ';

    },




  });

</script>
<!--<script type='text/javascript'>
var timerId = null, timeout = 5;
</script>
<script type='text/javascript'>
function WaitUntilCustomerGUIDIsRetrieved() {
if (!!(timerId)) {
    if (timeout == 0) {
return;
}
if (typeof this.GetElqCustomerGUID === 'function') {
        document.forms["TEST_signup-1465575899166"].elements["elqCustomerGUID"].value = GetElqCustomerGUID();
return;
}
timeout -= 1;
}
timerId = setTimeout("WaitUntilCustomerGUIDIsRetrieved()", 500);
return;
}
window.onload = WaitUntilCustomerGUIDIsRetrieved;
_elqQ.push(['elqGetCustomerGUID']);
</script>-->
